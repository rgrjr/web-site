<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>ICanCAD: Schematic connectivity</title>
</head>

<body bgcolor=white>
<h2>Schematic Connectivity</h2>

<p><a href="/"><tt>Home</tt></a> : <a href="./">ICanCAD</a> :
<a href="user.html">User's Guide</a> : Schematic Connectivity
<hr>

<p>A <a href="glossary.html#net">net</a> represents a single bit; a <a
href="glossary.html#bus">bus</a> may be composed of any number of bits.
Here we define how ICanCAD allows busses to be specified and used.  This
covers the hierarchical aspect of connectivity within ICanCAD itself;
see the "Netlisting" page [TBD; or the <a href="busses.html">network
internals page</a>] for information on producing flat and hierarchical
netlists.

<h3>Table of contents</h3>

<!-- hhmtoc start -->
<ol>
  <li> Schematic Connectivity
       <ol>
	 <li> Table of contents
	 <li> <a href="#introduction">Introduction</a>
	 <li> <a href="#syntax">Net label syntax</a>
	      <ol>
		<li> <a href="#simple-net">Simple nets</a>
		<li> <a href="#conc">Concatenation</a>
		<li> <a href="#conn">Net labels</a>
		<li> <a href="#pin-name">Pin labels</a>
		<li> <a href="#context">Net context</a>
	      </ol>
	 <li> <a href="#special-devices">Schematic primitives that define connectivity</a>
	      <ol>
		<li> <a href="#bus-width">Bus-width icons</a>
		<li> <a href="#tap">Tap and ripper icons</a>
	      </ol>
	 <li> <a href="#semantics">Connectivity semantics</a>
	      <ol>
		<li> <a href="#bus-creation">Bus creation</a>
		<li> Bus width and use iteration determination
		<li> Net creation
		<li> <a href="#ports-and-globals">Ports and globals</a>
	      </ol>
	 <li> <a href="#extractor-errors">Errors reported by the extractor</a>
	 <li> <a href="#compatibility">Bus compatibility</a>
       </ol>
</ol>
<!-- hhmtoc end -->

<a name="introduction">
<h3>Introduction</h3>

<blockquote class="definition">

A <b>schematic bus</b> represents a collection of physical wires that
are treated as a unit; each drawn wire in a schematic can be though of
as carrying a bus, and may therefore represent more than one wire in the
layout.  Each bus contains one or more <a
href="glossary.html#net">nets</a>, in a specified order, where the
number of nets is the bus' <a href="glossary.html#width">width</a>.  The
individual nets can be subscripted, as in <tt>"wide&lt;5&gt;"</tt>, so
the bus therefore acts like a one-dimensional array of nets.  Busses can
be extracted from other busses with <tt>"wide&lt;3:8&gt;"</tt>.
</blockquote>

<p>Note that the order of subscripts is significant;
<tt>"wide&lt;3:8&gt;"</tt> is not the same as
<tt>"wide&lt;8:3&gt;"</tt>.

<blockquote class="definition">

A <b>schematic net</b> represents the part of a single wire in the
layout that falls inside a given schematic.
</blockquote>

<p>Busses, nets, and their names are local to the schematic in which they
appear.

<p>[need a good general introduction to globals.  must have discussion
of how globals are bound, and the presence of "virtual globals" in
higher-level schematics.  -- rgr, 22-Jan-03.]

<a name="syntax">
<h3>Net label syntax</h3>

[need intro here.  -- rgr, 18-Jan-03.]

<p>In the syntax descriptions below, curly braces ("{" and "}") mean "zero
or more" of the enclosed construct, square braces ("[" and "]") mean
"zero or one," vertical bars ("|") mean alternation, and apostrophes
("'") surround a literal token.  Alternation has the lowest precedence.

<a name='simple-net'>
<h4>Simple nets</h4>

<blockquote>
<pre>
&lt;simple-net&gt;       ::= &lt;identifier&gt; [ '&lt;' &lt;subscript-list&gt; '&gt;' ]

&lt;subscript-list&gt;   ::= &lt;range&gt; { ',' &lt;range&gt; }

&lt;range&gt;            ::= &lt;integer&gt; | &lt;integer&gt; ':' &lt;integer&gt;

</pre>
</blockquote>

The simplest specification is just a name, possibly subscripted, such as
<tt>"Clk"</tt> or <tt>"rdata&lt;8:11&gt;"</tt>.  For maximum
interoperability, characters are currently restricted to the set of
alphanumerics plus underscore (<tt>"_"</tt>), and must start with a
letter or underscore, except that names starting with leading
underscores are reserved for system-generated names.  [should we allow
"-" as an extension character?  maybe "-" should be a "synonym" for "_"?
-- rgr, 18-Mar-01.]  This is equivalent to
<tt>"[a-zA-Z_][a-zA-Z0-9_]*"</tt> in the most common regular expression
syntax.

<p>Identifiers are case insensitive and may be specified in either case,
though ICanCAD tries to preserve case where possible.  [actually,
ICanCAD seems to uppercase names -- always.  -- rgr, 10-Jan-03.]  For
example, if you use the name <tt>"ClkB"</tt> consistently, then ICanCAD
will adopt that capitalization pattern; if (for example) you use
<tt>"ClkB"</tt>, <tt>"clkb"</tt>, and <tt>"CLKB"</tt>, then ICanCAD will
pick one arbitrarily -- and then use <i>that</i> pattern consistently.
Because the choice is arbitrary, the capitalization picked may vary from
session to session, or even between consecutive extractions in the same
session.

<p>Subscripts may be used to pick out a single bit, or range or set of
bits; order is important.  <tt>"rdata&lt;8:11&gt;"</tt> is equivalent to
<tt>"rdata&lt;8,9:11&gt;"</tt> and <tt>"rdata&lt;8,9,10,11&gt;"</tt>,
but not equivalent to <tt>"rdata&lt;11:8&gt;"</tt>, which specifies the
same bits in the reverse order.  Note that subscripted nets always imply
a width, and all implied bus widths must be consistent with the actual
bus width.

<p>[need to declare our byte sex: are we big-endian, or little endian?
what does janus do?  -- rgr, 19-Mar-01.]  [we seem to be big-endian by
default . . . and unfortunately, that is not easy to change.  -- rgr,
18-Jan-03.]

<p>[In the future, this syntax will be extended to include a
<tt>"use.port"</tt> variant for <tt>&lt;net&gt;</tt>, to allow
connecting to uses by name, e.g. by adding a net label with
<tt>"inv1.out&nbsp;=&nbsp;inv2.in"</tt> in order to cascade a pair of
inverters.  Both the use name and the port name will follow the
<tt>&lt;simple-net&gt;</tt> syntax, to allow for iterated uses and port
busses.  -- rgr, 18-Mar-01.]

<p>[do we want to disallow zero-width busses?  -- rgr, 18-Mar-01.]

<a name=conc>
<h4>Concatenation</h4>

<blockquote>
<pre>
&lt;concatenation&gt;    ::= &lt;net&gt; { ',' &lt;net&gt; }

&lt;net&gt;              ::= &lt;simple-net&gt; | &lt;repeated-net&gt;

&lt;repeated-net&gt;     ::= &lt;simple-net&gt; '#' &lt;integer&gt;
</pre>
</blockquote>

<p>One can construct wider busses by concatenating them by name from
smaller busses.  For instance, a net label with
<tt>"data&lt;31:0&gt;&nbsp;=&nbsp;sign,mag"</tt> would be
one way to specify that the connected bus is named <tt>"data"</tt>, and 

<p>The repeated-net syntax is just a shorthand for concatenating the
same bus to itself a given number of times.  For example, if the width
of GND is known to be 1, then <tt>"GND#8"</tt> defines an eight-bit-wide
GND bus (i.e. eight bits all shorted to GND).  Note that the bus need
not be a single bit; if <tt>"Byte"</tt> is eight bits wide, then
<tt>"Byte#4"</tt> is 32 bits widw.

<a name=conn>
<h4>Net labels</h4>

<blockquote>
<pre>
&lt;connection&gt;       ::= &lt;concatenation&gt; { '=' &lt;concatenation&gt; }
</pre>
</blockquote>

The "goal" of a net label specification is a
<tt>&lt;connection&gt;</tt>, which is said to <i>label</i> the bus with
one or more <tt>&lt;concatenation&gt;</tt> constructs.  All labels that
consist of an unconcatenated and unsubscripted identifier are considered
to <i>name</i> the bus; the bus may be given more than one name, in one
or more net labels.  [May want to distinguish between port names and
other names.  -- rgr, 14-Nov-01.]  The name <tt>"NC"</tt> (in any
mixture of upper and lower case) is special in that it is never used to
name any bus.  Separate collections of wiring can be shorted together by
naming them with the same name (as long as it is not <tt>"NC"</tt>).
[The <tt>NC</tt> feature is not yet implemented, though it's a good
idea, and seems pretty straightforward.  It may be useful to define
<tt>NC</tt> as always being one bit wide, so you would say
<tt>"NC#4"</tt> in a concatenation to ignore four bits.  -- rgr,
18-Jan-03.]

<p>All &lt;concatenation&gt; constructs within the &lt;connection&gt;
for a given net label are equivalent, as if they were wired together.
In fact, putting <tt>"foo&nbsp;=&nbsp;bar"</tt> on a single net label
has the identical effect as putting <tt>"foo"</tt> on one net label and
<tt>"bar"</tt> on another, and then wiring them together.

<a name='pin-name'>
<h4>Pin labels</h4>

<blockquote>
<pre>
&lt;pin-name&gt;       ::= &lt;simple-net&gt; | &lt;identifier&gt; '/' &lt;integer&gt;
</pre>
</blockquote>

<p>A pin requires a name, possibly subscripted; the subscript can be
used to make the width explicit, such as in <tt>"byte&lt;7:0&gt;"</tt>.
Alternatively, one can specify a name and an explicit width, separated
by a slash, so <tt>"byte/8"</tt> would be another way to say the same
thing.

<p>[should we allow a <tt>&lt;repeated-net&gt;</tt>?  may want to think
about this more.  -- rgr, 14-Nov-01.]

<a name=context>
<h4>Net context</h4>

Each net has a <i>context</i> property that describes how it is used:
<ul>
  <li> <tt>:local</tt> means that the net only has connections within
       the def, including explicit connections to child uses.  (This is
       the default.)
  <li> <tt>:port</tt> means that the net may be used to connect the def
       to its hierarchical parent.  (It may not be, because the def may
       appear with an icon that does not have a pin for the port.  In
       that case, the net behaves like a local.)
  <li> <tt>:global</tt> means that the net is implicitly connected to a
       net of the same name at some higher level of hierarchy.  The
       global name must <i>not</i> appear on a pin, and the bus to which
       the net label is connected must be exactly one bit wide.  Note
       that a global net of the same name need not even exist explicitly
       in the parent.
</ul>

Net context is declared by setting the <tt>:context</tt> property of a
net label.  Since context is really declared on a bus, any
<tt>:port</tt> or <tt>:global</tt> declaration is propagated to all bits
of the bus.  (An explicit <tt>:local</tt> declaration is ignored, lest
it become impossible to put nets with different context together on the
same bus.)

<p>To avoid ambiguity, each global net must have a single name, its
<i>global name</i>.  All globals with the same global name anywhere in
the design are shorted together <i>globally</i>.  [probably not true if
different immediate parents have local or port nets with the same names
as a global in the children.  -- rgr, 14-Nov-01.]  For this reason,
connections such as <tt>"foo=bar"</tt> on net labels declared global are
not allowed.  [Similarly, "GND#3" is not supported, though perhaps it
ought to be.  -- rgr, 14-Nov-01.]

<p>[need to say more about :global semantics.  -- rgr, 14-Nov-01.]

<a name="special-devices">
<h3>Schematic primitives that define connectivity</h3>

There are two kinds of primitive devices, bus-width icons and tap/ripper
icons, that affect the extraction process directly by specifying bus
properties, instead of contributing circuit elements.  These devices are
distinguished by having a <tt>special-device</tt> property that declares
which to type the device belongs.  Special devices are not
process-specific; the extractor will not complain if you use a special
device from another process; the flattener and hierarchical netlisters
will not even see special devices.

<p>There is no graphical user interface at present for defining special
devices, but this can be done using the <a
href="commands.html#com-eval">"Eval"</a> command as follows:
<pre>
    ICC: Eval <i>(form)</i> (setf (>> special-device) :bus-width)
</pre>
It should be stressed that this property must <em>not</em> be defined
for circuit element devices, or they will not be extracted properly.

<p>Note that special devices do not have well-defined
<tt>iterations</tt> properties; their values are ignored.

<a name="bus-width">
<h4>Bus-width icons</h4>

A bus-width icon has a <tt>special-device</tt> property of
<tt>:bus-width</tt>, and usually a single port, with an arbitrary name.
These icons are conventionally called <tt>bus-width.sicon</tt>; for
example, the generic process that is distributed with ICanCAD includes a
bus-width icon called
<tt>icancad:process:generic:primitives;bus-width.sicon</tt>.  They must
have a <tt>width</tt> parameter, which a user can set to an integer
value on a use of the bus-width icon.

<a name="tap">
<h4>Tap and ripper icons</h4>

A tap or ripper icon has a <tt>special-device</tt> property of
<tt>:tap</tt>, at least one port named <tt>"inbus"</tt>, and at least
one port named <tt>"outbus"</tt>.  (Multiple ports with the same name
provide feedthroughs, same as for any other icon.)  The <tt>bits</tt>
parameter specifies a set of subscripts, in the syntax defined by the <a
href="#simple-net"><tt>&lt;subscript-list&gt;</tt> production</a>; these
bits are taken out of <tt>"inbus"</tt> and <tt>"outbus"</tt> Not only
does this define the bits of <tt>"outbus"</tt> as a subset of those of
<tt>"inbus"</tt>, it also defines the width of <tt>"outbus"</tt>.

<p>Note that there is no semantic difference between a "tap" and a "bus
ripper" -- the difference is purely stylistic, being a matter of how the
icons are drawn.  Taps usually have a triangular "spigot" pointing away
from the <tt>"inbus"</tt> connection, whereas rippers use a diagonal
line.  The generic process that is distributed with ICanCAD includes the
<tt>icancad:process:generic:primitives;tap.sicon</tt> and
<tt>icancad:process:generic:primitives;ripper.sicon</tt> icons that fit
these descriptions.

<a name="semantics">
<h3>Connectivity semantics</h3>

The process of deducing the connectivity of a given def from the
physical clues provided by wires and net labels is called <a
href="glossary.html#extraction">"extraction"</a>.  The deduced
connectivity information includes data structures describing the def's
nets and busses, and where they connect.  Connections implied by wiring
in the drawing are thus described explicitly in a uniform way for the
sake of netlisting.

<p>During the extraction process, the various means of specifying
connections are also checked for internal consistency.  Connections to
the def's children are checked, and the set of ports that may be used to
connect the def to its hierarchical parent are determined.

<p>Extraction is divided into three general phases: bus creation, bus
width determination, and net creation.  [For a more detailed description
of the algorithm, see the <a href="busses.html#extraction">"Extraction"
section</a> in the <a href="internals.html"> <b>Internal
Documentation</b></a> set.  -- rgr, 18-Jan-03.]

<a name="bus-creation">
<h4>Bus creation</h4>

Loosely speaking, a bus object is created internally for every
collection of connected wires.  However, there are two ways to make
connections by name:
<ol>
  <li> If two ports of a given use have the identical name, then this
       implies a feed-through, and the wires that connect to them are
       made part of the same bus.  [Currently, "identical name" is
       defined by <tt>string-equal</tt>, i.e. the strings must be
       identical except for case.  -- rgr, 18-Jan-03.]
  <li> If two net labels include the same name in such a way that it
       spans the entire width, then they are considered part of the same
       bus.
</ol>
As an example of connection by name, consider the net label
<tt>"A=B&lt;7:0&gt;=C&lt;15:8&gt;"</tt>.  This defines the busses
<tt>A</tt>, <tt>B&lt;7:0&gt;</tt>, and <tt>C&lt;15:8&gt;</tt> as
equivalent, but only <tt>A</tt> unambiguously names the net label's bus.
Because of the subscript range, <tt>C</tt> cannot be a name for this
bus, but must exist elsewhere as a bus of at least 16 bits in order for
the subscripts to be valid.  Similarly, <tt>B&lt;7:0&gt;</tt> might be a
slice of a larger bus defined elsewhere, in which case <tt>B</tt> cannot
be a name for this bus, but if <tt>B</tt> is eight bits wide, then
<tt>B&lt;7:0&gt;</tt> and <tt>B</tt> are equivalent notations that mean
"all of bus <tt>B</tt>."  In either case, please note that there must be
a bus somewhere that is unambiguously named <tt>B</tt> so that this can
be checked.  [must describe this better.  -- rgr, 18-Jan-03.]

<p>By-name connections are transitive; if three sets of wires have net
labels <tt>"A"</tt>, <tt>"A=B"</tt>, and <tt>"B"</tt>, then both names
and all three net labels will end up referring to the same bus.

<h4>Bus width and use iteration determination</h4>

Bus widths and use iterations stand in the following relationship:
<blockquote>
&lt;Width of connected bus&gt; = &lt;Use iterations&gt; * &lt;Port
width&gt;
</blockquote>
The port width has already been determined at this point by extracting
the child, so the use iteration count can be used to compute an unknown
bus width; similarly, a known bus with can be used to determine the use
interation count.

<p>Solving for width/iteration values is done in several phases, in
order to support propagation of width information in both directions.
We look for "intrinsic" width/iteration clues first, before trying to
propagate values.  The only intrisic way to define use iteration counts
is to specify the <tt>iterations</tt> property of the use.  Bus widths
may be defined explicitly in one of several ways:

<ul>
  <li> A <a href="#bus-width">bus-width icon</a> declares the width
       explicitly.
  <li> A concatenation of explicit subrange specifications directly
       imply the total number of bits, e.g. the bus with
       <tt>"A&lt;7:0&gt;,B&lt;31:24&gt;"</tt> must be exactly 16 bits
       wide.
  <li> A tap "out" or "side" connection always has a subrange such as
       <tt>"1,3,5,15-8"</tt>, which similarly defines the width.
</ul>

<p>Next, we propagate width information from busses of known width to
uses with unknown <tt>iterations</tt> values, and from uses with known
iteration counts to busses of unknown width.  [There are two problems
with the current implementation:  (1) The code only does a single
bus-&gt;iterations phase followed by an iterations-&gt;bus phase; and
(2) once we determine a width for a use that is greater than 1, it gets
set permanently.  -- rgr, 18-Jan-03.]

<p>Finally, if there are still any busses with undetermined width, they
area given a width of 1.  [Though I can't think of any reason why any
busses should still exist in that state.  -- rgr, 18-Jan-03.]

<h4>Net creation</h4>

Each bit position of each bus is then filled with a <a
href="glossary.html#net">net</a> object that represents the bit.  The
connections implied by the net labels are made explicit by putting the
same net object in the corresponding position in every net label
specification.  For example, if a bus is 5 bits wide and has net labels
that say <tt>"Q"</tt>, <tt>"A,C&lt;3:0&gt;"</tt> and
<tt>"X&lt;5:7&gt;,Y,Z"</tt> (and we must assume that busses <tt>A</tt>,
<tt>Y</tt>, and <tt>Z</tt> are each one bit wide), then the extractor
ensures that
<pre>
       Q&lt;4&gt; = A&lt;0&gt; = X&lt;5&gt;
       Q&lt;3&gt; = C&lt;3&gt; = X&lt;6&gt;
       Q&lt;2&gt; = C&lt;2&gt; = X&lt;7&gt;
       Q&lt;1&gt; = C&lt;1&gt; = Y&lt;0&gt;
       Q&lt;0&gt; = C&lt;0&gt; = Z&lt;0&gt;
</pre>
If there had been only one net label with
<tt>"Q&nbsp;=&nbsp;A,C&lt;3:0&gt;&nbsp;=&nbsp;X&lt;5:7&gt;,Y,Z"</tt>,
the result would have been the same.

<p>Note that one-bit busses <tt>A</tt>, <tt>Y</tt>, and <tt>Z</tt> must
exist elsewhere in the schematic.  In other words, it is not possible to
say <tt>"A&lt;2:0&gt;=X,Y,Z"</tt> to name the bits of the three-bit bus
<tt>A</tt> without also creating <tt>X</tt>, <tt>Y</tt>, and <tt>Z</tt>
busses elsewhere in the schematic.

<p>Once the nets exist, they acquire a <a href="#context">net signal
context</a> from the net labels of their connected busses, as described
above.

<p>Finally, nets are assigned names.  Busses of width 1 lend their
primary name to their nets.  Nets that do not otherwise have a name are
assigned generated names such as <tt>"NET1"</tt>, <tt>"NET2"</tt>, etc.;
these are assigned sequentially, as long as the name is not already in
use.  [currently, that's all we do for name assignment, which may be
inadequate.  -- rgr, 15-Jan-03.]

<a name="ports-and-globals">
<h4>Ports and globals</h4>

[should probably say something about how ports and globals get exported
to the next hierarchical level.  -- rgr, 18-Jan-03.]

<a name="extractor-errors">
<h3>Errors reported by the extractor</h3>

[This is actually describes a general mechanism that is currently used
only by the extractor.  When it gets used for other things, such as
visiting all of the uses of a given def, we'll find a better place for
it.  -- rgr, 18-Jan-03.]

<p>When the extractor encounters errors, it reports each of them in the
typeout window as they happen, and stuffs them away for later.  Each
error is treated as a <a href="glossary.html#possibility">
<b>possibility</b></a> so that they can be corrected one by one later on
(without having to read the typescript to figure out which error
happened where).

<p>[finish.  -- rgr, 18-Jan-03.]

<a name='compatibility'>
<h3>Bus compatibility</h3>

[need to give some tips on how to stay compatible -- in syntax and
semantics -- with other CAD systems . . .  -- rgr, 10-Jan-03.]

<p>
<hr>
<address><a href="mailto:rogers@rgrjr.dyndns.org">Bob Rogers
	<tt>&lt;rogers@rgrjr.dyndns.org&gt;</tt></a></address>
<!-- hhmts start -->
Last modified: Wed Jan 22 21:12:25 EST 2003
<!-- hhmts end -->
</body> </html>
