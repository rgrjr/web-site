<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">

<html>
<head>
<title>Bob:  Subversion</title>
<link href="../site.css" title="Default" rel="stylesheet" type="text/css">
</head>

<body>
<h2>Running a Subversion <tt>mod_dav_svn</tt> server</h2>

<p><a href="/"><tt>Home</tt></a> : <a href="index.html">Linux
resources</a> : Subversion server
<hr>

<!-- hhmtoc start -->
<ol>
  <li> Running a Subversion <tt>mod_dav_svn</tt> server
       <ol>
	 <li> Setting up a Subversion server using Apache and HTTPS
	      <ol>
		<li> Set up Apache <tt>mod_ssl</tt>
		<li> Build Subversion to use Apache and SSL
		<li> Configure Apache to use <tt>mod_dav_svn</tt>
		<li> Set up Apache2 to use <tt>mod_authz_svn</tt>
		<li> Test the new server
	      </ol>
	 <li> <a href="#usage">Moving existing repositories to Subversion</a>
	      <ol>
		<li> Migrate <tt>rgr-hacks</tt> to Subversion
		<li> Create a new Subversion repository
	      </ol>
       </ol>
</ol>
<!-- hhmtoc end -->

<p>
<h3>Setting up a Subversion server using Apache and HTTPS</h3>

This recipe was used to set my server up initially on SuSE 9.0 (where
the shipped RPM edition of Subversion is so old as to be completely
useless, so I built Subversion 1.3.0 from the tarball), and when I
migrated it to different hardware running <a
href="http://www.opensuse.org/">openSUSE 10.2</a> (which comes with
Subversion 1.4.0).

<p>Much of this is specific to the details of the SuSE configuration.
Other installations will require larger or smaller grains of salt.

<h4>Set up Apache <tt>mod_ssl</tt></h4>

<ol>
  <li> Create an SSL certificate.  For testing, I created a self-signed
       cert using a recipe from the OpenSSL <tt>man</tt> page:
       <pre>
       openssl req -x509 -newkey rsa:1024 -keyout key.pem -out req.pem
       </pre>
       Then, copy <tt>key.pem</tt> to
       <tt>/etc/apache2/ssl.key/server.key</tt> (this is the private
       key), and <tt>req.pem</tt> to
       <tt>/etc/apache2/ssl.crt/server.crt</tt> (this is the self-signed
       certificate).  Needless to say, I will have to do better if I
       want anyone else to be able to use this.
  <li> Configure Apache 2.x for SSL.  This consists of (a) copying (or
       renaming) <tt>/etc/apache2/vhosts.d/vhost-ssl.template</tt> to
       <tt>vhost-ssl.conf</tt> (in the same directory), and (b) changing
       <tt>/etc/sysconfig/apache2</tt> to add <tt>"-D&nbsp;SSL"</tt> to
       <tt>APACHE_SERVER_FLAGS</tt> and increase
       <tt>APACHE_START_TIMEOUT</tt> to 10 seconds (so that you have
       time to type in a passphrase).
  <li> Restart Apache via <tt>"/etc/init.d/apache2&nbsp;restart"</tt>.
       This requires supplying the passphrase used to protect the server
       private key.
  <li> Verify that SSL is working by visiting the HTTPS version of the
       site.
</ol>

<h4>Build Subversion to use Apache and SSL</h4>

This step is only necessary if you have an old distro release.  If the
release you have includes at least Subversion 1.2, then you are probably
better off sticking to the distro version, which is undoubtedly already
compiled correctly to play nicely with Apache.

<ol>
  <li> Ensure that the <tt>openssl-devel</tt> and <tt>apache2-devel</tt>
       packages are installed so that Subversion's <tt>./configure</tt>
       script can find their respective header files.
  <li> Configure Subversion as follows:
       <pre>
       CFLAGS=`apxs2 -q CFLAGS` ./configure --enable-shared \
               --with-ssl --with-apxs=`which apxs2` --disable-mod-activation
       </pre>
       These options have the following effect:
       <p>
       <ul>
	 <li> <tt>--enable-shared</tt> forces the building of shared
	      libraries.  (I had thought this was enabled by default; I
	      was wrong.)
	 <li> OpenSSL is <b>not</b> autodetected, so an explicit
	      <tt>--with-ssl</tt> is required for "HTTPS" URL support,
	      even for the client.
	 <li> The <tt>--with-apxs</tt> option requests Apache shared
	      library support; the <tt>"apxs2"</tt> value is necessary
	      for Apache 2.x under SuSE, where all of the Apache 2.x
	      directories and binaries have a "2" appended.
	 <li> And <tt>--disable-mod-activation</tt> is necessary in
	      order to tell <tt>apxs2</tt> to skip trying to add
	      "LoadModule" lines to <tt>httpd.conf</tt>; apparently,
	      this is a problem with the SuSE setup.
       </ul>
       Some of this may be voodoo, but I can tell you that without
       <tt>--enable-shared</tt> plus the <tt>CFLAGS</tt> magic, Apache
       segfaulted every time it got a WebDAV request.
  <li> Do <tt>"make"</tt> to compile.
  <li> As root, do <tt>"make install"</tt>.  (I had to remove the "-a"
       at the end of the <tt>INSTALL_MOD_SHARED</tt> line in the
       generated <tt>Makefile</tt> by hand, because I didn't know I
       needed <tt>--disable-mod-activation</tt> until too late.)
</ol>

<h4>Configure Apache to use <tt>mod_dav_svn</tt></h4>

This sets up <tt>mod_dav_svn</tt> to serve multiple repositories (using
the <tt>SVNParentPath</tt> option) with anonymous read access and
authenticated write access using the same user credentials for all
repositories.  See below for a recipe that uses <tt>mod_authz_svn</tt>
to provide per-directory access control.

<ol>
  <li> Create the <tt>/shared/svn</tt> directory, and at least one
       repository under it, and <tt>chown</tt> it to the <tt>wwwrun</tt>
       user.  I created a <tt>/shared/svn/new-vc/</tt>
       subdirectory and copied an existing repository there; this shows
       up on the server as <a href="https://rgrjr.dyndns.org/svn/new-vc/">
       <tt>https://rgrjr.dyndns.org/svn/new-vc/</tt></a>.
  <li> Add <tt>dav</tt> and <tt>dav_svn</tt> to the
       <tt>APACHE_MODULES</tt> list in <tt>/etc/sysconfig/apache2</tt>.
       Note that this list is order-dependent, so <tt>dav</tt> must
       appear before <tt>dav_svn</tt>.
  <li> Create users in <tt>/etc/svn-auth-file</tt> using the Apache
       <tt>htpasswd</tt> utility.  See the <a
       href="http://svnbook.red-bean.com/nightly/en/svn.serverconfig.httpd.html">
       Basic HTTP Authentication</a> section of <a
       href="http://svnbook.red-bean.com/nightly/en/">the SVN book</a>
       for an example.
  <li> Add the following to
       <tt>/etc/apache2/vhosts.d/vhost-ssl.conf</tt> within the
       <tt>&lt;VirtualHost&gt;</tt> definition:
       <pre>
       # Subversion server setup.  -- rgr, 20-Mar-06.
       &lt;Location /svn&gt;
	 DAV svn
	 # any "/svn/foo" URL will map to a repository /shared/svn/foo
	 SVNParentPath /shared/svn

	 # how to authenticate.
	 AuthType Basic
	 AuthName "Subversion repository at rgrjr.dyndns.org"
	 AuthUserFile /etc/svn-auth-file

         # require authentication for anything beyond read access.
	 &lt;LimitExcept GET PROPFIND OPTIONS REPORT&gt;
	   Require valid-user
	 &lt;/LimitExcept&gt;
       &lt;/Location&gt;
       </pre>
  <li> Restart the server.
</ol>

<h4>Set up Apache2 to use <tt>mod_authz_svn</tt></h4>

<ol>
  <li> Add <tt>mod_authz_svn</tt> after <tt>dav_svn</tt> in the
       <tt>APACHE_MODULES</tt> list in <tt>/etc/sysconfig/apache2</tt>.
  <li> Change the <tt>&lt;Location&nbsp;/svn&gt;</tt> section in the
       <tt>/etc/apache2/vhosts.d/vhost-ssl.conf</tt> file to look like
       this:
       <pre>
	# Subversion server setup.  -- rgr, 13-Dec-07.
	&lt;Location /svn&gt;
	  DAV svn
	  # any "/svn/foo" URL will map to a repository /shared/svn/foo
	  SVNParentPath /shared/svn

	  # access control policy file.
          AuthzSVNAccessFile /etc/svn-access.conf

	  # try anonymous access first, resort to real
	  # authentication if necessary.
	  Satisfy Any
	  Require valid-user

	  # how to authenticate.
	  AuthType Basic
	  AuthName "Subversion repository at rgrjr.dyndns.org [new]"
	  AuthUserFile /etc/svn-auth-file
	&lt;/Location&gt;
       </pre>

       The difference between this and the previous
       <tt>&lt;Location&gt;</tt> recipe is that the
       <tt>&lt;LimitExcept&gt;</tt> part is is replaced by top-level
       "Require valid-user" and "Satisfy Any" options, and the
       <tt>AuthzSVNAccessFile</tt> identifies an access file.  Note that
       user credentials are still defined with <tt>htpasswd</tt> in
       <tt>/etc/svn-auth-file</tt> as before.
  <li> Create the <tt>/etc/svn-access.conf</tt> file with the necessary
       per-directory permissions.  An early version of mine looks like
       this:
       <pre>
       # Subversion authentication.  See
       # <a href="http://svnbook.red-bean.com/nightly/en/svn.serverconfig.pathbasedauthz.html">http://svnbook.red-bean.com/nightly/en/svn.serverconfig.pathbasedauthz.html</a>
       # for details.

       [/]
       # Allow everyone to read the entire repository, unless overridden.
       * = r
       # Give write permission to rogers and rgr.
       rogers = rw
       rgr = rw

       [lap-config:/]
       # This is private, so we need "* =" to revoke anonymous reads, and
       # "rogers = rw" to reinstate write permission.
       * =
       rogers = rw
       </pre>

       The <tt>"[/]"</tt> paragraph reinstates the anonymous
       read/authenticated write policy of the previous section for all
       directories of all repositories, and the final paragraph
       restricts all access to the <tt>lap-config</tt> repository to
       <tt>rogers</tt>.
  <li> Restart the server so that all of this will take effect.
</ol>

<h4>Test the new server</h4>

<ol>
  <li> Test checking out:
       <pre>
       svn co https://rgrjr.dyndns.org/svn/new-vc/rogers/emacs/new-vc/trunk new-vc2
       </pre>
  <li> Find a version-controlled file in Emacs.
  <li> View its log (<tt>C-x v l</tt> in Emacs).
  <li> Modify and save it.
  <li> Diff it against the original (<tt>C-x v =</tt>).
  <li> Check it in (<tt>C-x v v</tt>).
  <li> View the updated log.
</ol>

<a name="usage">
<h3>Moving existing repositories to Subversion</h3>

Here we give an example of using <tt>cvs2svn</tt> to convert an existing
CVS repository to Subversion, and of creating a new repository as a
fresh checkin.

<h4>Migrate <tt>rgr-hacks</tt> to Subversion</h4>

This uses <a href="http://cvs2svn.tigris.org/cvs2svn.html">
<tt>cvs2svn</tt></a>, which is distributed along with openSUSE 10.2.
For concreteness, we convert the <tt>rgr-hacks</tt> code (online at <a
href="https://rgrjr.dyndns.org/svn/rgr-hacks/">
<tt>https://rgrjr.dyndns.org/svn/rgr-hacks/</tt></a>), but this recipe
should work generically.

<ol>
  <li> Ensure that all image files (and anything else that shouldn't
       have EOL conversion done) is marked as "-kb" in the CVS
       repository.  This doesn't matter for CVS as long as you only
       develop on Unix-like systems, but <tt>cvs2svn</tt> gets it wrong
       if these files are not marked properly in the repository.
       (Unless you specify <tt>--mime-type</tt> and
       <tt>--eol-from-mime-type</tt> to <tt>cvs2svn</tt>, but I have not
       tried this.)

       <p>To find these files in a working copy:
       <pre>
       rogers@rgr&gt; cd ~/emacs/rgr-hacks
       rogers@rgr&gt; find . -type f -name Entries \
		       | xargs -e egrep -n -e '\.(png|jpg|gif)/' \
		       | fgrep -v /-kb/
       </pre>
       To fix them:
       <pre>
       rogers@rgr&gt; cvs admin -kb *.jpg
       rogers@rgr&gt; cvs update
       </pre>
       Note that <tt>cvs admin</tt> operates on the repository
       immediately; the <tt>cvs update</tt> is only needed to update the
       working copy, but that is useful for subsequent searches.

  <li> Create the repository (as root):
       <pre>
       # svnadmin create /shared/svn/rgr-hacks
       # chown -R rogers /shared/svn/rgr-hacks
       </pre>
  <li> As <tt>rogers</tt>, populate it with the CVS contents:
       <pre>
       rogers@rgr&gt; cvs2svn --existing-svnrepos -s /shared/svn/rgr-hacks/ /shared/cvsroot/rogers/emacs/rgr-hacks/
       </pre>
       Note that by default, <tt>cvs2svn</tt> will stuff everything that
       is not a branch into a <tt>trunk/</tt> subdirectory.
  <li> Give it back to the Web server user (as root, of course):
       <pre>
       # chown -R wwwrun /shared/svn/rgr-hacks
       </pre>
  <li> Test by checking out a fresh working copy:
       <pre>
       rogers@rgr&gt; cd ..
       rogers@rgr&gt; mv rgr-hacks rgr-hacks.cvs
       rogers@rgr&gt; svn co https://rgrjr.dyndns.org/svn/rgr-hacks/trunk rgr-hacks
       rogers@rgr&gt; diff -ur rgr-hacks.cvs rgr-hacks
       </pre>
       Note that <tt>diff</tt> will find many trivial differences in
       <tt>&#36;Id:$</tt> tags.  If image files are reported to be
       different, then you probably need to go back to step 1.
</ol>

<h4>Create a new Subversion repository</h4>

This shows how to populate a repository from scratch using <a
href="http://svnbook.red-bean.com/nightly/en/svn.ref.svn.c.import.html">
<tt>svn import</tt></a>, rather than from the contents of a CVS
repository.

<ol>
  <li> Create an empty repository on the server (as root):
       <pre>
       rgrjr:~ # svnadmin create /shared/svn/lap-config
       rgrjr:~ # chown -R wwwrun.www /shared/svn/lap-config
       rgrjr:~ # 
       </pre>

  <li> Move the files into a new <tt>tmp/trunk</tt> directory.
       <tt>tmp</tt> needs to contain everything that is to go into the
       new repository; the name "tmp" will not appear in the repository,
       but everything below it will.  <tt>tmp/trunk</tt> is the <a
       href="http://svnbook.red-bean.com/nightly/en/svn.tour.importing.html#svn.tour.importing.layout">
       recommended place to put the main development version</a> of a
       system.
       <pre>
       rogers@lap&gt; mkdir -p tmp/trunk
       rogers@lap&gt; cd tmp/trunk
       rogers@lap&gt; tar xzf source-of-files.tgz
       rogers@lap&gt; cd ../..
       rogers@lap&gt; ls tmp/trunk/
       fstab.mgi     hosts.random     README.text.~1~    routes.rgrjr
       fstab.random  ntp.conf.mgi     resolv.conf.mgi    site-setup
       HOSTNAME.mgi  ntp.conf.random  resolv.conf.rgrjr  ssh_config
       hosts.mgi     README.text      routes.mgi         sshd_config
       rogers@lap&gt; 
       </pre>
       Note that Subversion will not include <tt>README.text.~1~</tt>,
       knowing that it is an old version of the <tt>README.text</tt>
       file.

  <li> Import the files:
       <pre>
       rogers@lap&gt; svn import tmp https://rgrjr.dyndns.org/svn/lap-config -m "Initial import (SuSE 9.1)"
       Adding         tmp/trunk
       Adding         tmp/trunk/hosts.random
       Adding         tmp/trunk/README.text
       Adding         tmp/trunk/ssh_config
       Adding         tmp/trunk/resolv.conf.rgrjr
       Adding         tmp/trunk/sshd_config
       . . .

       Committed revision 1.
       rogers@lap&gt; svn list https://rgrjr.dyndns.org/svn/lap-config
       trunk/
       rogers@lap&gt; 
       </pre>

  <li> The <tt>tmp/</tt> directory tree is no longer needed.
       <pre>
       rogers@lap&gt; rm -fr tmp
       </pre>

  <li> Check it out:
       <pre>
       rogers@lap&gt; svn co https://rgrjr.dyndns.org/svn/lap-config/trunk lap-config
       A    lap-config/hosts.random
       A    lap-config/README.text
       A    lap-config/ssh_config
       A    lap-config/resolv.conf.rgrjr
       A    lap-config/sshd_config
       A    lap-config/HOSTNAME.mgi
       A    lap-config/routes.mgi
       A    lap-config/ntp.conf.mgi
       A    lap-config/site-setup
       A    lap-config/ntp.conf.random
       A    lap-config/routes.rgrjr
       A    lap-config/resolv.conf.mgi
       A    lap-config/fstab.mgi
       A    lap-config/hosts.mgi
       A    lap-config/fstab.random
       Checked out revision 1.
       rogers@lap&gt; cd lap-config/
       rogers@lap&gt; ls
       fstab.mgi     hosts.mgi     ntp.conf.random  resolv.conf.rgrjr  site-setup
       fstab.random  hosts.random  README.text      routes.mgi         ssh_config
       HOSTNAME.mgi  ntp.conf.mgi  resolv.conf.mgi  routes.rgrjr       sshd_config
       rogers@lap&gt; 
       </pre> 
       This creates a normal working copy.
</ol>

<p>
<hr>
<address><a href="/bob/contact.html">Bob Rogers
	<tt>&lt;rogers@rgrjr.dyndns.org&gt;</tt></a></address>
$Id$
</body>
</html>
