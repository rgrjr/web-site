<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">

<html>
<head>
<title>Bob:  Subversion</title>
<link href="../site.css" title="Default" rel="stylesheet" type="text/css">
</head>

<body>
<h2>Running a Subversion <tt>mod_dav_svn</tt> server</h2>

<p><a href="/"><tt>Home</tt></a> : <a href="index.html">Linux
resources</a> : Subversion server
<hr>

<p>
<h3>Setting up a Subversion server using Apache and HTTPS</h3>

Much of this is specific to the details of the SuSE 9.0 configuration.
In particular, I can use Apache 2.0 as distributed by SuSE, but the RPM
edition of Subversion that ships with 9.0 is so old as to be completely
useless, so I needed to build Subversion from the tarball; in my case, I
used Subversion 1.3.0.  Other installations will require larger or
smaller grains of salt.

<h4>Set up Apache <tt>mod_ssl</tt></h4>

<ol>
  <li> Create an SSL certificate.  For testing, I created a self-signed
       cert using a recipe from the OpenSSL <tt>man</tt> page:
       <pre>
       openssl req -x509 -newkey rsa:1024 -keyout key.pem -out req.pem
       </pre>
       Then, copy <tt>key.pem</tt> to
       <tt>/etc/apache2/ssl.key/server.key</tt> (this is the private
       key), and <tt>req.pem</tt> to
       <tt>/etc/apache2/ssl.crt/server.crt</tt> (this is the self-signed
       certificate).  Needless to say, I will have to do better if I
       want anyone else to be able to use this.
  <li> Configure Apache 2.0 for SSL.  This consists of (a) copying (or
       renaming) <tt>/etc/apache2/vhosts.d/vhost-ssl.template</tt> to
       <tt>vhost-ssl.conf</tt> (in the same directory), and (b) changing
       <tt>/etc/sysconfig/apache2</tt> to add <tt>"-D&nbsp;SSL"</tt> to
       <tt>APACHE_SERVER_FLAGS</tt> and increase
       <tt>APACHE_START_TIMEOUT</tt> to 10 seconds (so that you have
       time to type in a passphrase).
  <li> Restart Apache via <tt>"/etc/init.d/apache2&nbsp;restart"</tt>.
       This requires supplying the passphrase used to protect the server
       private key.
  <li> Verify that SSL is working by visiting the HTTPS version of the
       site.
</ol>

<h4>Build Subversion to use Apache and SSL</h4>

<ol>
  <li> Ensure that the <tt>openssl-devel</tt> and <tt>apache2-devel</tt>
       packages are installed so that Subversion's <tt>./configure</tt>
       script can find their respective header files.
  <li> Configure Subversion as follows:
       <pre>
       CFLAGS=`apxs2 -q CFLAGS` ./configure --enable-shared \
               --with-ssl --with-apxs=`which apxs2` --disable-mod-activation
       </pre>
       These options have the following effect:
       <p>
       <ul>
	 <li> <tt>--enable-shared</tt> forces the building of shared
	      libraries.  (I had thought this was enabled by default; I
	      was wrong.)
	 <li> OpenSSL is <b>not</b> autodetected, so an explicit
	      <tt>--with-ssl</tt> is required for "HTTPS" URL support,
	      even for the client.
	 <li> The <tt>--with-apxs</tt> option requests Apache shared
	      library support; the <tt>"apxs2"</tt> value is necessary
	      for Apache 2.0 under SuSE, where all of the Apache 2.0
	      directories and binaries have a "2" appended.
	 <li> And <tt>--disable-mod-activation</tt> is necessary in
	      order to tell <tt>apxs2</tt> to skip trying to add
	      "LoadModule" lines to <tt>httpd.conf</tt>; apparently,
	      this is a problem with the SuSE setup.
       </ul>
       Some of this may be voodoo, but I can tell you that without
       <tt>--enable-shared</tt> plus the <tt>CFLAGS</tt> magic, Apache
       segfaulted every time it got a DAV request.
  <li> Do <tt>"make"</tt> to compile.
  <li> As root, do <tt>"make install"</tt>.  (I had to remove the "-a"
       at the end of the <tt>INSTALL_MOD_SHARED</tt> line in the
       generated <tt>Makefile</tt> by hand, because I didn't know I
       needed <tt>--disable-mod-activation</tt> until too late.)
</ol>

<h4>Configure Apache to use <tt>mod_dav_svn</tt></h4>

<ol>
  <li> Create the <tt>/shared/svn</tt> directory, and at least one
       repository under it, and <tt>chown</tt> it to the <tt>wwwrun</tt>
       user.  I created a <tt>/shared/svn/new-vc/</tt>
       subdirectory and copied an existing repository there; this shows
       up on the server as <a href="https://rgrjr.dyndns.org/svn/new-vc/">
       <tt>https://rgrjr.dyndns.org/svn/new-vc/</tt></a>.
  <li> Add <tt>dav</tt> and <tt>dav_svn</tt> to the
       <tt>APACHE_MODULES</tt> list in <tt>/etc/sysconfig/apache2</tt>.
  <li> Create users in <tt>/etc/svn-auth-file</tt> using
       <tt>htpasswd</tt>.  See the "Basic HTTP Authentication" section
       of <a
       href="http://svnbook.red-bean.com/nightly/en/svn.serverconfig.httpd.html">the
       SVN book</a> for an example.
  <li> Add the following to
       <tt>/etc/apache2/vhosts.d/vhost-ssl.conf</tt> within the
       <tt>&lt;VirtualHost&gt;</tt> definition:
       <pre>
       # Subversion server setup.  -- rgr, 20-Mar-06.
       &lt;Location /svn&gt;
	 DAV svn
	 # any "/svn/foo" URL will map to a repository /shared/svn/foo
	 SVNParentPath /shared/svn

	 # authentication goo.
	 AuthType Basic
	 AuthName "Subversion repository at rgrjr.dyndns.org"
	 AuthUserFile /etc/svn-auth-file
	 &lt;LimitExcept GET PROPFIND OPTIONS REPORT&gt;
	   Require valid-user
	 &lt;/LimitExcept&gt;
       &lt;/Location&gt;
       </pre>
  <li> Restart the server.
</ol>

<h4>Test</h4>

<ol>
  <li> Test checking out:
       <pre>
       svn co https://rgrjr.dyndns.org/svn/new-vc/rogers/emacs/new-vc/trunk new-vc2
       </pre>
  <li> Find a version-controlled file in Emacs.
  <li> View its log (<tt>C-x v l</tt> in Emacs).
  <li> Modify and save it.
  <li> Diff it against the original (<tt>C-x v =</tt>).
  <li> Check it in (<tt>C-x v v</tt>).
  <li> View the updated log.
</ol>

<h4>Migrate <tt>rgr-hacks</tt> to Subversion</h4>

This should work generically.

<ol>
  <li> Create the repository (as root):
       <pre>
       svnadmin create /shared/svn/rgr-hacks
       chown -R rogers /shared/svn/rgr-hacks
       </pre>
  <li> As <tt>rogers</tt>, populate it with the CVS contents:
       <pre>
       cvs2svn --existing-svnrepos -s /shared/svn/rgr-hacks/ /shared/cvsroot/rogers/emacs/rgr-hacks/
       </pre>
       Note that by default, <a
       href="http://cvs2svn.tigris.org/cvs2svn.html">
       <tt>cvs2svn</tt></a> will stuff everything that is not a branch
       into a <tt>trunk/</tt> subdirectory.
  <li> Give it back to the Web server user (as root, of course):
       <pre>
       chown -R wwwrun /shared/svn/rgr-hacks
       </pre>
  <li> Test by checking out a fresh working copy:
       <pre>
       svn co https://rgrjr.dyndns.org/svn/rgr-hacks/trunk rgr-hacks
       diff -ur rgr-hacks.cvs rgr-hacks
       </pre>
       Note that <tt>diff</tt> will find many trivial differences in
       <tt>&#36;Id:$</tt> tags.
</ol>

<p>
<hr>
<address><a href="/bob/contact.html">Bob Rogers
	<tt>&lt;rogers@rgrjr.dyndns.org&gt;</tt></a></address>
$Id$
</body>
</html>
