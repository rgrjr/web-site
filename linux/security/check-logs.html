<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<title>check-logs.pl</title>
</head>

<body bgcolor=white>
<h2>The <tt>check-logs.pl</tt> script</h2>

<p><a href="/">Home</a> : <a href="/linux/">Linux</a> : <a
href="">Security</a> : <tt>check-logs.pl</tt>
<hr>

<p>[This is not publicly available yet, though I have written this page
because I needed documentation anyway.  The plan is to release it
sometime in the summer of 2000, time constraints permitting.  -- rgr,
29-May-00.]

<!-- hhmtoc start -->
<ol>
  <li> The <tt>check-logs.pl</tt> script
       <ol>
	 <li> <a href="#check-logs"><tt>check-logs.pl</tt></a>
	 <li> <a href="#subsys">Selecting which subsystems to report</a>
	 <li> <a href="#example"><tt>check-logs.pl</tt> Example</a>
	 <li> <a href="#install">Installation</a>
       </ol>
</ol>
<!-- hhmtoc end -->

<a name= check-logs>
<h3><tt>check-logs.pl</tt></h3>

<p>The <tt>check-logs.pl</tt> script analyzes the system messages in the
<tt>/var/log/messages</tt> file (or whatever is supplied on the command
line or on standard input), suppressing uninteresting noise and printing
selected messages and summaries of network traffic.

<p><b>Synopsis:</b>
<pre>
    check-logs.pl [-from <i>date-string</i>] [-nodns] \
                  [-report <i>subsys</i>] [-ignore <i>subsys</i>] \
                  <i>logfile</i> . . .
</pre>

<p><b>Arguments:</b>
<dl>
  <dt> <b>-from</b> <i>date-string</i>
  <dd> if specified, entries are ignored until the specified
       <tt><i>date-string</i></tt> is encountered.  This is something of
       a kludge; <tt><i>date-string</i></tt> must be of the form
       <tt>"Apr&nbsp;&nbsp;2"</tt> (with space- instead of
       zero-padding), since <tt>check-logs.pl</tt> just looks for a line
       that starts with this prefix.
  <dt> <b>-ignore</b> <i>subsys</i>
  <dt> <b>-report</b> <i>subsys</i>
  <dd> specifies that messages from the indicated subsystem should be
       ignored or reported, respectively; used to override the builtin
       defaults.  <a href="#subsys">See below</a> for more information.
  <dt> <b>-nodns</b>
  <dd> turns off reverse lookup used to map IP addresses into domain
       names.  If omitted (the default), both names and addresses are
       shown; if specified, the output will only show IP addresses.
</dl>

<a name=subsys>
<h3>Selecting which subsystems to report</h3>

The "subsystem" is what I am calling the name that appears after the
date, time, and hostname on the log line, optionally 
followed by a version number or a process ID in brackets, and terminated
with a colon.  For example, in the line
<pre><font size=-1>
    May 26 00:18:23 h0050da615e79 PAM_pwdb[17756]: (login) session closed for user rogers
</pre></font>
the subsystem name would be <tt>"PAM_pwdb"</tt>.

<p>[At present, you can also say such things as
<tt>"-ignore&nbsp;www/tcp"</tt> or <tt>"-ignore&nbsp;80/tcp"</tt> if you
want to shut off the daily summaries of network connections to the given
port (specified either by port number or by name as given in the
<tt>/etc/services</tt> file).  The implementation is somewhat hackish,
so I'm not sure whether to make this a permanent feature or not.  --
rgr, 3-Jun-00.]

<p>Some subsystems are more informative than others, so it is useful to
have the <tt>-report</tt> and <tt>-ignore</tt> options to turn them on
and off.  The following defaults were chosen to minimize uninteresting
spew and maximize potentially significant events.

<blockquote>
<table border=2>
  <tr> <th>Subsystem</th> <th>Default</th> <td>Explanation</td> </tr>
  <tr>
    <td>PAM_pwdb</td> <td>report</td>
    <td> Reports login, logout, and "su" events. </td>
  </tr>
  <tr> <td>end_request</td> <td>ignore</td> <td>??</td> </tr>
  <tr> <td>floppy0</td> <td>ignore</td> <td>Uninteresting</td> </tr>
  <tr> <td>identd</td> <td>ignore</td> <td>Uninteresting</td> </tr>
  <tr>
    <td>kernel</td> <td>report</td>
    <td> Such things as boot messages and removable disk changes come
	 from the kernel.  (So does <tt>ipchains</tt> packet logging,
	 but we handle those specially.) </td>
  </tr>
  <tr>
    <td>named</td>
    <td>ignore</td>
    <td> Messages from the DNS server (which I run as a cache for the
	 home network).  BIND generates tons of useless messages.
    </td>
  </tr>
  <tr>
    <td>pumpd</td> <td>report</td>
    <td> Terse, and potentially very interesting, especially since I
	 haven't yet figured out how to automate all the chaos that
	 happens when my IP address changes.  [It's only happened once.
	 -- rgr, 29-May-00.] </td>
  </tr>
  <tr>
    <td>default</td> <td>report</td>
    <td> Not really a subsystem, this controls reporting of other
	 subsystems not explicitly named.
    </td>
  </tr>
</table>
</blockquote>

<p>In addition, the <tt>nominal-startup.text</tt>,
<tt>nominal-shutdown.text</tt>, and <tt>nominal-random.text</tt> files
that live in the <tt>/root/bin</tt> directory are used to suppress the
normal startup and shutdown (and other) drivel that would otherwise tend
to dominate the logs if you reboot daily.  If a line after the date,
time, and hostname matches a line in one of these files <b>exactly</b>,
then that ilne is always unconditionally suppressed.

<a name=example>
<h3><tt>check-logs.pl</tt> Example</h3>

This is a real-life example, produced by summarizing the logs from June
2 and part of June 3.

<pre><font size=-1>
[root@h0050da615e79 /root]# check-logs.pl <a href="#note-from">-from 'Jun  2'</a> /var/log/messages

Jun  2:
  00:09:20: <a href="#note-pam">PAM_pwdb</a>: (login) session closed for user rogers
  09:52:16: PAM_pwdb: (login) session opened for user rogers by LOGIN(uid=0)
  11:12:12: PAM_pwdb: (login) session closed for user rogers
  21:41:04: PAM_pwdb: (login) session opened for user rogers by LOGIN(uid=0)
  22:25:52: PAM_pwdb: (su) session opened for user root by (uid=500)
  22:25:59: PAM_pwdb: (su) session closed for user root
  22:26:12: PAM_pwdb: (su) session opened for user nsadmin by (uid=0)
  22:26:34: PAM_pwdb: (su) session closed for user nsadmin
  23:34:39: PAM_pwdb: (login) session closed for user rogers
  <a href="#note-nhs">Network host summaries:</a>
    From terminator.rsug.itd.umich.edu (141.211.164.2)
      smtp/tcp (22 attempts, disp ACCEPT)
    From homepage.lcs.mit.edu (18.30.2.64)
      smtp/tcp (2 attempts, disp ACCEPT)
    From knight.cons.org (194.233.237.86)
      smtp/tcp (3 attempts, disp ACCEPT)
    From eubank.netcraft.com (195.188.192.37)
      www/tcp (1 attempts, disp ACCEPT)
    From mout01.kundenserver.de (195.20.224.132)
      smtp/tcp (1 attempts, disp ACCEPT)
    From lists.securityfocus.com (207.126.127.68)
      smtp/tcp (17 attempts, disp ACCEPT)
    From cable-49.landmarknet.net (208.242.91.50)
      www/tcp (5 attempts, disp ACCEPT)
    From <a href="#note-brackets">[209.192.230.183]</a>
      www/tcp (2 attempts, disp ACCEPT)
    From xcom-78-127.mdc.net (209.251.78.127)
      www/tcp (1 attempts, disp ACCEPT)
    From c904200-a.frmt1.sfba.home.com (24.1.68.85)
      <a href="#note-asp">asp/tcp</a> (1 attempts, disp REJECT)
    From h002078c5f4df.ne.mediaone.net (24.147.18.108)
      www/tcp (1 attempts, disp ACCEPT)

Jun  3:
  09:58:17: PAM_pwdb: (login) session opened for user rogers by LOGIN(uid=0)
  16:34:14: PAM_pwdb: (su) session opened for user root by (uid=500)
  16:34:40: PAM_pwdb: (su) session closed for user root
  16:34:57: kernel: <a href="#note-fs">EXT2-fs warning</a>: maximal mount count reached, running e2fsck is recommended 
  Network host summaries:
    From terminator.rsug.itd.umich.edu (141.211.164.2)
      smtp/tcp (4 attempts, disp ACCEPT)
    From vivalasvegas.mr.itd.umich.edu (141.211.83.35)
      smtp/tcp (1 attempts, disp ACCEPT)
    From [203.242.184.66]
      <a href="#note-domain">domain/tcp</a> (1 attempts, disp REJECT)
    From maynard.mail.mindspring.net (207.69.200.243)
      smtp/tcp (1 attempts, disp ACCEPT)

Message totals (unfiltered):
  12 from PAM_pwdb
  38 from <a href="#note-identd">identd</a>
  64 from kernel

IP host totals:
  [203.242.184.66] (1 connects)
  eubank.netcraft.com (195.188.192.37) (1 connects)
  terminator.rsug.itd.umich.edu (141.211.164.2) (26 connects)
  [209.192.230.183] (2 connects)
  homepage.lcs.mit.edu (18.30.2.64) (2 connects)
  lists.securityfocus.com (207.126.127.68) (17 connects)
  xcom-78-127.mdc.net (209.251.78.127) (1 connects)
  vivalasvegas.mr.itd.umich.edu (141.211.83.35) (1 connects)
  mout01.kundenserver.de (195.20.224.132) (1 connects)
  knight.cons.org (194.233.237.86) (3 connects)
  cable-49.landmarknet.net (208.242.91.50) (5 connects)
  c904200-a.frmt1.sfba.home.com (24.1.68.85) (1 connects)
  maynard.mail.mindspring.net (207.69.200.243) (1 connects)
  h002078c5f4df.ne.mediaone.net (24.147.18.108) (1 connects)

Destination port totals:
  smtp/tcp (51 connects)
  <a href="#note-asp">asp/tcp</a> (1 connects)
  <a href="#note-domain">domain/tcp</a> (1 connects)
  www/tcp (10 connects)
[root@h0050da615e79 /root]# 
</pre></font>

Notes:
<dl>
  <a name=note-from>
  <dt> <b><tt>-from 'Jun&nbsp;&nbsp;2'</tt></b>
  <dd> Note how the date needs to be in the same format as the logs,
       with a space instead of a leading zero for the day.
       <a name=note-pam>
  <dt> <b><tt>PAM_pwdb</tt></b>
  <dd> These messages could be shut off by adding:
       <pre>
       -ignore PAM_pwdb
</pre>
       to the command line.  But don't; this will tell you if anyone is
       trying to guess passwords on your system.  (If root has already
       been compromised, then the cracker will ordinarily always remove
       the telltale lines from the log, but sometimes they might get
       sloppy.)
       <a name=note-nhs>
  <dt> <b>Network host summaries</b>
  <dd> This section shows connections (actually, packets) logged by <a
       href="firewall.html"> <tt>ipchains</tt></a> when given the
       <tt>"-l"</tt> option, collected by host & port, and summarised
       for each day.  The first host,
       <tt>terminator.rsug.itd.umich.edu</tt>, made 22 <tt>smtp/tcp</tt>
       connections because it serves the <a
       href="http://www.umich.edu/~rsug/netatalk/mailing.html">
       <tt>netatalk-admins</tt> mailing list</a>, to which I subscribe.
       <a name=note-brackets>
  <dt> <b><tt>"[209.192.230.183]"</tt></b>
  <dd> This notation is used when the IP address can't be mapped to a
       host name using reverse DNS lookup.  This is not a problem in and
       of itself; not all ISPs have names for all of their assigned
       addresses.
       <a name=note-asp>
  <dt> <b><tt>asp/tcp</tt></b>
  <dd> This hit may be a cause for concern, but I don't know what the
       "Address Search Protocol" is about, so I'm not sure.  I can't
       find anything about it at the <a
       href="http://www.rfc-editor.org/">RFC Editor</a> site, so that
       makes me suspicious.
       <a name=note-fs>
  <dt> <b><tt>EXT2-fs</tt> warning</b>
  <dd> This is just the sort of message you should be looking for when
       scanning the logs.  I had mounted a Zip disk, and the file system
       module was recommending that I check it for consistency using the
       <tt>e2fsck</tt> program, since that is a good thing to do
       periodically (and it needs to be done when the disk is mounted
       read-only).
       <a name=note-domain>
  <dt> <b><tt>domain/tcp</tt></b>
  <dd> There is no reason anyone should be asking my machine for
       <tt>domain/tcp</tt> service; if it were a misconfigured machine
       that thought I was its designated DNS server, it would have been
       <tt>domain/udp</tt> instead.  So, this probably represents a
       cracker trying to do a "zone transfer," which is a way to get a
       whole list of machine names and addresses to exploit.
       <a name=note-identd>
  <dt> <b><tt>identd</tt></b>
  <dd> <tt>identd</tt> provides the <a
       href="ftp://ftp.isi.edu/in-notes/rfc912.txt">authentication
       service</a> on port 113.  This allows a mail server on a remote
       host, for instance, to query the client machine for the user ID
       (i.e. login name) that owns the connection to the server.  It is
       in fact an extremely weak form of authentication, so I don't
       bother to use it, but running a server may speed up connections
       for other services on other hosts, lest the remote host wait for
       an answer from a service that isn't there.  (The alternative is
       to reject the connection at the firewall, as opposed to denying
       it.)
</dl>

<a name=install>
<h3>Installation</h3>

<p>[This is not publicly available yet.  The plan is to release it
sometime in the summer of 2000, time constraints permitting.  -- rgr,
29-May-00.]

<p><tt>check-logs.pl</tt> expects to be installed in <tt>/root/bin</tt>
along with its <tt>nominal-random.text</tt>,
<tt>nominal-shutdown.text</tt>, and <tt>nominal-startup.text</tt> files.
If you put the <tt>*.text</tt> files someplace else, you will have to
change the init for the <tt>$nominal_file_directory</tt> variable in the
script.  In any case, you will want to put your own startup/shutdown
noise in these files, since these messages are very system-dependent.

<p>
<hr>
<address><a href="mailto:rogers@rgrjr.dyndns.org">Bob Rogers
	<tt>&lt;rogers@rgrjr.dyndns.org&gt;</tt></a></address>
<!-- hhmts start -->
Last modified: Sun Apr 27 21:24:12 EDT 2003
<!-- hhmts end -->
</body> </html>
