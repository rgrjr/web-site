<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>This is obsolete</title>
</head>

<body bgcolor=white>
<h1>This is obsolete</h1>

[old xauth stuff from ssh.html, kept here for archival reasons.  -- rgr,
14-Nov-01.]

<a name = cookie-how>
<h4>Using <tt>xauth</tt> to copy cookies</h4>

[I've just reorganized this section extensively; it is probably in need
of further cleanup.  -- rgr, 19-Jul-01.]

<p>Here's a series of recipes I have developed for copying X11 cookies
back and forth.  In all of these descriptions, the <i>source account</i>
is the account under which you started the X server (or SSH proxy X
server) to which <tt>$DISPLAY</tt> points, and the <i>destination
account</i> is the one to which you'd like to copy the cookie.
Unfortunately, there are many cases depending upon whether the
destination account is privileged, and whether NFS or SSH is involved.

<p>Note that the source account is usually your initial login on the
machine running the display, but this is not true when the connection is
made via SSH.  If you have done
<tt>"ssh&nbsp;user@randomhost.foo.com"</tt>, then SSH will start a proxy
server on <tt>randomhost</tt> and set <tt>$DISPLAY</tt> on
<tt>randomhost.foo.com</tt> to be something like
<tt>"randomhost:10.0"</tt>.  To connect to the proxy, and hence the
original display over the encrypted connection, you will need
<tt>user</tt>'s cookie for <tt>"randomhost:10.0"</tt>, regardless who
owns the physical display.

<p>In any case, once you have done <tt>"su"</tt>, the destination user
will inherit the source user's <tt>$XAUTHORITY</tt> value, which is
usually the wrong thing.  If so, you can do something like:
<blockquote>
<pre>
% old_xauth=$XAUTHORITY
% export XAUTHORITY=~/.Xauthority
%
</pre>
</blockquote>
(in Bourne shell syntax) to rectify this.

<dl>
  <dt> <b>Destination is <tt>root</tt>, and <tt>$DISPLAY</tt> points to
       an SSH2 proxy on the local host:</b>
  <dd> In this case, <tt>$XAUTHORITY</tt> points to something like
       <tt>/tmp/ssh-XXwOjqG6/cookies</tt> on the local host, which root
       can read, so you should be able to launch X11 apps as root
       without doing anything special (as long as you keep this value of
       <tt>$XAUTHORITY</tt> intact).  You would only need to copy
       cookies if you subsequently connect to another host via rsh or
       telnet (not ssh) and set <tt>$DISPLAY</tt> to the original proxy.
       In this case, one of the other recipes should apply, but remember
       that you have to do it on the <tt>$DISPLAY</tt> host (where the
       proxy is running, because that's the only place where the
       <tt>$XAUTHORITY</tt> file is accessible).

       <p>
  <dt> <b>Destination is <tt>root</tt> and can read the source
       <tt>.Xauthority</tt> file:</b>
  <dd> If you are "su root" and root can read your <tt>.Xauthority</tt>
       file directly, then it's a relatively simple matter.  For this to
       work, you must be root, and one of
       the following must be true:
       <ul>
	 <li> <tt>$DISPLAY</tt> points to an SSH version 2 proxy on the
	      local host (since SSH2 stores cookies in <tt>/tmp/</tt>,
	      see also the previous recipe); OR
	 <li> The <tt>.Xauthority</tt> file is on the local disk; OR
	 <li> The <tt>.Xauthority</tt> file is mounted over NFS with the
	      <tt>no_root_squash</tt> option.  (To check this, try
	      <tt>"wc ~user/.Xauthority"</tt>; if you get "Permission
	      denied", then try the next recipe.)
       </ul>

       <p>
       All that is needed in this case is a straight copy:
       <pre>
       # whoami
       root
       # xauth -f ~rogers/.Xauthority extract - $DISPLAY | xauth merge -
       # 
       </pre>
       The first <tt>xauth</tt> invocation takes the cookie for
       <tt>"$DISPLAY"</tt> from your <tt>.Xauthority</tt> file; the
       second one merges it into that of the current account, which is
       root.  On some systems, you may have to say
       <tt>"/usr/bin/X11/xauth"</tt> instead of <tt>"xauth"</tt> in both
       places, as <tt>/usr/bin/X11</tt> is not on root's <tt>PATH</tt>
       by default.

       <p>[Note:  I just tried this on a Solaris 2.6 machine
       (<tt>kendrew.bu.edu</tt>, to be specific), and it
       <tt>chown</tt>'ed the <tt>~rogers/.Xauthority</tt> file to
       <tt>root</tt>!  Since the permissions on this file must be 600,
       this made it impossible for me to open new X11 connections.  Once
       I <tt>chown</tt>'ed it back to myself, things resumed working.
       I've never had this problem on the Alphas, so it's probably a
       vendor/version thing.  -- rgr, 20-Dec-00.]

       <p>
  <dt> <b>Destination is <tt>root</tt> but cannot read the source
       <tt>.Xauthority</tt> file:</b>
  <dd> If you are "su root" and your home directory is mounted via NFS
       with "root squashing" in effect, then root won't be able to read
       your <tt>.Xauthority</tt> file, so the recipe above won't work.
       In that case, you can regain your priviledge by using "su", as
       follows:
       <pre>
       su -c "xauth -f /home/rogers/.Xauthority extract - $DISPLAY" rogers | xauth merge -
       </pre>
       (Before doing this, you will probably also need to reset
       $XAUTHORITY; see above.)  This executes
       <pre>
       xauth -f /home/rogers/.Xauthority extract - $DISPLAY
       </pre>
       as <tt>rogers</tt> in order to read the security file, since in
       this case <tt>rogers</tt> can do what root cannot.  Ironically,
       "su" does not ask for a password, since root is always
       priviledged to become anyone else.  This defeats some of the
       security advantage of "root squashing" (though it is still useful
       to defend against rogue clients who pretend to be root).

       <p>
  <dt> <b>Destination is not priviledged:</b>
  <dd> In principle, you could use this same recipe for other user ID's
       by making your <tt>.Xauthority</tt> file temporarily world
       readable, but a safer tactic (and simpler, since you can do it
       all in one shell) is to use <tt>ssh</tt> to pipe it to/from
       <tt>xauth</tt> running as the source user.  The only disadvantage
       is that you have to supply a password for the source account.
       Here is the "pull" version:
       <pre>
       % whoami
       psa
       % ssh rogers@localhost /usr/bin/X11/xauth extract - $DISPLAY | xauth merge -
       rogers@127.0.0.1's password: 
       % 
       </pre>
       The first <tt>xauth</tt> invocation is run under the <tt>rogers</tt>
       user ID by the <tt>ssh</tt> command, where it takes the cookie for
       <tt>"$DISPLAY"</tt> from the default <tt>.Xauthority</tt> file (mine);
       the second one merges the cookie into <tt>~psa/.Xauthority</tt>.  The
       explicit path on the first invocation (i.e. using
       <tt>"/usr/bin/X11/xauth"</tt> instead of just <tt>"xauth"</tt>) will
       probably be required; the <tt>$PATH</tt> environment variable used by
       SSH when running commands doesn't usually include the X11
       executable directory.  <tt>"/usr/bin/X11/xauth"</tt> is the correct path
       if <tt>localhost</tt> is an Alpha, but it will usually be
       <tt>"/usr/X11R6/bin/xauth"</tt> on systems using XFree86 (including
       Linux).

       <p>The "push" version should work just as well:
       <pre>
       % whoami
       rogers
       % xauth extract - $DISPLAY | ssh psa@localhost /usr/bin/X11/xauth merge -
       psa@127.0.0.1's password: 
       % 
       </pre>
       (Though I've only actually tried the "pull" version myself.)
</dl>

<p>
<hr>
<address><a href="mailto:rogers@rgrjr.dyndns.org">Bob Rogers
	<tt>&lt;rogers@rgrjr.dyndns.org&gt;</tt></a></address>
<!-- hhmts start -->
Last modified: Wed Nov 14 14:47:10 EST 2001
<!-- hhmts end -->
</body> </html>
